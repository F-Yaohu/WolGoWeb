<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOL Web Manager - <!--VERSION--></title>
    <!-- Pico.css for nice default styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root {
            --primary: #1890ff; /* Blue */
            --del-color: #ff4d4f; /* Red */
        }
        body {
            /* Basic default styles from pico are good, but we customize colors */
        }
        /* Override Pico Colors for Buttons */
        button.primary, button[type="submit"] {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .container { 
            max-width: 960px; 
            margin: 0 auto;
            padding: 2rem 2rem 3rem;
        }
        
        .dashboard-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 2rem 2rem 3rem;
        }
        
        @media (min-width: 1024px) {
            .dashboard-container {
                padding: 2rem 3rem 3rem;
            }
        }
        
        /* Status Indicators */
        .status-dot-large {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        .status-online { background-color: #52c41a; }
        .status-offline { background-color: #bfbfbf; }
        
        .device-card {
            margin-bottom: 1.5rem;
            border: 1px solid #e8e8e8;
            padding: 1.5rem;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        .device-card:hover { 
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        /* Device Name */
        .device-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .header-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .header-actions button, .header-actions select {
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .action-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Better Modal Footer Buttons */
        article > footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
        }
        article > footer button, article > footer a[role="button"] {
            margin-bottom: 0;
            width: auto;
        }
        @media (max-width: 576px) {
            article > footer { flex-direction: column; }
            article > footer button, article > footer a[role="button"] { width: 100%; }
        }
        
        /* Sortable Headers */
        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { color: var(--primary); }
        .sort-icon::after {
            content: 'â†•';
            font-size: 0.8em;
            margin-left: 4px;
            opacity: 0.5;
        }
        .sort-asc::after { content: 'â†‘'; opacity: 1; }
        .sort-desc::after { content: 'â†“'; opacity: 1; }

        /* Dialog Animations */
        dialog { 
            transition: opacity 0.2s ease, transform 0.2s ease;
            border-radius: 12px;
        }
        dialog[open] { animation: fadeIn 0.3s ease-out; }
        dialog article {
            max-width: 500px;
            margin: auto;
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(-30px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        /* Helpers */
        .text-muted { color: #8c8c8c; font-size: 0.85em; }
        .text-error { color: #ff4d4f; font-size: 0.85em; margin-top: 0.25rem; }
        .input-error { border-color: #ff4d4f !important; }
        
        .device-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .device-info-item {
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .device-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .device-actions button {
            flex: 1;
            min-width: 0;
        }
        
        /* Password Eye */
        .password-wrapper { position: relative; }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            opacity: 0.6;
            background: none; border: none; padding: 0;
            width: auto; height: auto; margin-bottom: 0;
        }
        .password-toggle:hover { opacity: 1; }

        /* Focus States */
        :focus-visible { outline: 2px solid rgba(24, 144, 255, 0.4); border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); }
        
        /* Button text utilities */
        .btn-text-full { display: inline; }
        .btn-text-short { display: none; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-actions { 
                flex-direction: column; 
                align-items: stretch;
                gap: 1rem;
            }
            .action-group {
                width: 100%;
                justify-content: stretch;
            }
            .action-group button,
            .action-group select {
                flex: 1;
                min-width: 0;
            }
            .device-card footer { 
                flex-direction: column;
                gap: 0.75rem;
            }
            .device-card footer button {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .btn-text-full { display: none; }
            .btn-text-short { display: inline; }
            .action-group button {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }
            .action-group select {
                font-size: 0.85rem;
                padding: 0.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .container { padding: 1rem 0.5rem 2rem; }
            .device-card { padding: 1rem; }
        }

        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
        }
        
        @media (max-width: 576px) {
            .toast-container {
                left: 10px;
                right: 10px;
                top: 10px;
            }
            .toast {
                width: 100%;
            }
        }
        .toast {
            background: #333; color: #fff; padding: 10px 20px; border-radius: 4px; margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Login Page Styles */
        .login-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem;
        }
        
        .login-card {
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .login-header {
            text-align: center;
            padding: 2rem 1.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px 12px 0 0;
            color: white;
        }
        
        .login-header h2 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 600;
        }
        
        .login-header p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .login-body {
            padding: 2rem 1.5rem;
            background: white;
            border-radius: 0 0 12px 12px;
        }
        
        @media (max-width: 576px) {
            .login-card {
                max-width: 100%;
                margin: 0;
            }
            .login-header {
                padding: 1.5rem 1rem 0.75rem;
            }
            .login-header h2 {
                font-size: 1.5rem;
            }
            .login-body {
                padding: 1.5rem 1rem;
            }
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak :class="token ? 'dashboard-container' : ''">
        <!-- Toast Notifications -->
        <div class="toast-container">
            <div v-for="t in toasts" :key="t.id" class="toast" :style="{background: t.type === 'error' ? '#ff4d4f' : '#52c41a'}">
                {{ t.message }}
            </div>
        </div>

        <!-- Login Form -->
        <div v-if="!token" class="login-wrapper">
            <div class="login-card">
                <div class="login-header">
                    <h2>ğŸŒ WOL Manager</h2>
                    <p>Wake-on-LAN è®¾å¤‡ç®¡ç†é¢æ¿</p>
                </div>
                <div class="login-body">
                    <form @submit.prevent="login">
                        <div style="margin-bottom: 1.25rem;">
                            <label>
                                ç”¨æˆ·å
                                <input type="text" v-model="loginForm.username" autocomplete="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                            </label>
                        </div>
                        <div style="margin-bottom: 1.25rem;">
                            <label>
                                å¯†ç 
                                <div class="password-wrapper">
                                    <input :type="showPassword ? 'text' : 'password'" v-model="loginForm.password" autocomplete="current-password" required placeholder="è¯·è¾“å…¥å¯†ç ">
                                    <button type="button" class="password-toggle" @click="showPassword = !showPassword" tabindex="-1">
                                        {{ showPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸' }}
                                    </button>
                                </div>
                            </label>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" v-model="rememberUser" style="margin: 0;">
                                <span style="font-size: 0.9rem;">è®°ä½ç”¨æˆ·å</span>
                            </label>
                        </div>
                        
                        <p v-if="loginError" class="text-error" style="font-size: 0.95rem; font-weight: bold; margin-bottom: 1.25rem; padding: 0.75rem; background: #fff2f0; border-left: 3px solid var(--del-color); border-radius: 4px;">
                            âŒ {{ loginError }}
                        </p>

                        <button type="submit" :aria-busy="loading" class="primary" style="width: 100%; padding: 0.75rem;">
                            ğŸ” {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div v-else>
            <nav style="margin-bottom: 2rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                <ul style="margin: 0;">
                    <li><strong style="color: white; font-size: 1.25rem;">ğŸŒ WOL Manager</strong></li>
                </ul>
                <ul style="margin: 0;">
                    <li><a href="#" @click.prevent="logout" style="color: rgba(255,255,255,0.9); text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; background: rgba(255,255,255,0.1); transition: all 0.2s;" @mouseover="$event.target.style.background='rgba(255,255,255,0.2)'" @mouseout="$event.target.style.background='rgba(255,255,255,0.1)'">é€€å‡ºç™»å½•</a></li>
                </ul>
            </nav>

            <div class="header-actions">
                <div class="action-group">
                    <button @click="fetchDevices(true)" :aria-busy="refreshing" class="secondary outline">
                        <span class="btn-text-full">ğŸ”„ åˆ·æ–°</span><span class="btn-text-short">ğŸ”„</span>
                    </button>
                    <select v-model="filterStatus">
                        <option value="all">ğŸ“‹ å…¨éƒ¨</option>
                        <option value="online">âœ… åœ¨çº¿</option>
                        <option value="offline">â­• ç¦»çº¿</option>
                    </select>
                    <button @click="openScanModal" class="contrast outline">
                        <span class="btn-text-full">ğŸ” æ‰«æå±€åŸŸç½‘</span><span class="btn-text-short">ğŸ” æ‰«æ</span>
                    </button>
                </div>
                <div class="action-group">
                    <button @click="openAddDeviceModal" class="primary">
                        <span class="btn-text-full">â• æ·»åŠ è®¾å¤‡</span><span class="btn-text-short">â• æ·»åŠ </span>
                    </button>
                </div>
            </div>

            <!-- Sort Bar -->
            <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 0 10px; color: #666; font-size: 0.9em;">
                <span @click="sortBy('name')" class="sort-header" :class="getSortClass('name')">è®¾å¤‡å</span>
                <span @click="sortBy('last_online')" class="sort-header" :class="getSortClass('last_online')">æœ€è¿‘åœ¨çº¿</span>
            </div>

            <!-- Device List -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 0;">
                <div v-for="device in filteredDevices" :key="device.id" class="device-card">
                    <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                        <span class="status-dot-large" :class="device.is_online ? 'status-online' : 'status-offline'"></span>
                        <div class="device-name" style="margin: 0;">{{ device.name }}</div>
                        <span v-if="device.is_online" style="margin-left: auto; font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #52c41a; color: white; border-radius: 4px;">åœ¨çº¿</span>
                        <span v-else style="margin-left: auto; font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #bfbfbf; color: white; border-radius: 4px;">ç¦»çº¿</span>
                    </div>
                    <div class="device-info-grid">
                        <div class="device-info-item">
                            <small class="text-muted" style="display: block; margin-bottom: 0.25rem;">MAC åœ°å€</small>
                            <div style="font-family: monospace; font-size: 0.9rem;">{{ device.mac }}</div>
                        </div>
                        <div class="device-info-item">
                            <small class="text-muted" style="display: block; margin-bottom: 0.25rem;">IP åœ°å€</small>
                            <div style="font-family: monospace; font-size: 0.9rem;">{{ device.ip || 'N/A' }}</div>
                        </div>
                        <div class="device-info-item">
                            <small class="text-muted" style="display: block; margin-bottom: 0.25rem;">æœ€è¿‘åœ¨çº¿</small>
                            <div style="font-size: 0.9rem;">{{ formatTime(device.last_online) }}</div>
                        </div>
                    </div>
                    <div class="device-actions">
                        <button class="primary" @click="wakeDevice(device)" :aria-busy="device.waking" :disabled="device.waking" style="flex: 2;">
                            <span v-if="device.waking">å”¤é†’ä¸­...</span>
                            <span v-else><span class="btn-text-full">âš¡ å”¤é†’è®¾å¤‡</span><span class="btn-text-short">âš¡ å”¤é†’</span></span>
                        </button>
                        <button class="outline" @click="confirmDelete(device)" style="border-color: var(--del-color); color: var(--del-color);">
                            ğŸ—‘ï¸ <span class="btn-text-full">åˆ é™¤</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <p v-if="filteredDevices.length === 0" style="text-align: center; color: #666; margin-top: 3rem;">
                æš‚æ— è®¾å¤‡æˆ–ç­›é€‰ç»“æœä¸ºç©ºã€‚
            </p>

            <!-- Scan Modal -->
            <dialog :open="showScanModal" style="z-index: 1000;">
                <article style="max-width: 800px; width: 100%;">
                    <header>
                        <a href="#close" aria-label="Close" class="close" @click="showScanModal = false"></a>
                        æ‰«æå±€åŸŸç½‘è®¾å¤‡
                    </header>
                    <div v-if="scanning" style="text-align: center; padding: 40px;">
                        <span aria-busy="true">æ­£åœ¨æ‰«æç½‘ç»œ... è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</span>
                    </div>
                    <div v-else>
                        <p v-if="scannedDevices.length === 0">æœªæ‰¾åˆ°æ–°è®¾å¤‡ã€‚(è¯·ç¡®ä¿è®¾å¤‡å¤„äºå¼€æœºçŠ¶æ€)</p>
                        <table v-else role="grid">
                            <thead>
                                <tr>
                                    <th>IP åœ°å€</th>
                                    <th>MAC åœ°å€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="d in scannedDevices" :key="d.mac">
                                    <td style="font-family: monospace;">{{ d.ip }}</td>
                                    <td style="font-family: monospace;">{{ d.mac }}</td>
                                    <td>
                                        <button @click="addScannedDevice(d)" style="width: auto; padding: 0.5rem 1rem;">â• æ·»åŠ </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </article>
            </dialog>

            <!-- Add/Edit Device Modal -->
            <dialog :open="showAddModal" style="z-index: 1000;">
                <article>
                    <header>
                        <a href="#close" aria-label="Close" class="close" @click="showAddModal = false"></a>
                        æ·»åŠ æ–°è®¾å¤‡
                    </header>
                    <form @submit.prevent="addDevice" @keydown.enter.prevent="addDevice">
                        <div style="margin-bottom: 1rem;">
                            <label>
                                è®¾å¤‡åç§° <span style="color: var(--del-color);">*</span>
                                <input type="text" v-model="newDevice.name" required placeholder="ä¾‹å¦‚: å®¶ç”¨PC" ref="deviceNameInput">
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>
                                MAC åœ°å€ <span style="color: var(--del-color);">*</span>
                                <input type="text" v-model="newDevice.mac" 
                                    @input="formatMac" 
                                    :class="{'input-error': macError}"
                                    required placeholder="XX:XX:XX:XX:XX:XX" maxlength="17"
                                    style="font-family: monospace;">
                                <small v-if="macError" class="text-error">âŒ MACåœ°å€æ ¼å¼ä¸æ­£ç¡®</small>
                                <small v-else class="text-muted">æ ¼å¼: XX:XX:XX:XX:XX:XX</small>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>
                                IP åœ°å€ <small style="color: #999;">(å¯é€‰)</small>
                                <input type="text" v-model="newDevice.ip" placeholder="192.168.1.100" style="font-family: monospace;">
                                <small class="text-muted">ğŸ’¡ ç”¨äºå®æ—¶æ£€æµ‹è®¾å¤‡åœ¨çº¿çŠ¶æ€</small>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>
                                WOL ç«¯å£ <small style="color: #999;">(æ ‡å‡†ç«¯å£)</small>
                                <select v-model="newDevice.port" style="font-family: monospace;">
                                    <option value="9">9 (æ¨è - UDP æ ‡å‡†ç«¯å£)</option>
                                    <option value="7">7 (å¤‡ç”¨ - Echo ç«¯å£)</option>
                                    <option value="0">0 (ä»»æ„å¯ç”¨ç«¯å£)</option>
                                </select>
                                <small class="text-muted">ğŸ“¡ Wake-on-LAN åè®®æ ‡å‡†ä½¿ç”¨ç«¯å£ 9 æˆ– 7</small>
                            </label>
                        </div>
                        <footer style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e8e8e8;">
                            <button type="button" class="secondary" @click="showAddModal = false" style="min-width: 100px;">âŒ å–æ¶ˆ</button>
                            <button type="submit" :aria-busy="adding" :disabled="macError" class="primary" style="min-width: 100px;">âœ… ä¿å­˜</button>
                        </footer>
                    </form>
                </article>
            </dialog>

            <!-- Delete Confirmation -->
            <dialog :open="showDeleteModal" style="z-index: 1000;">
                <article style="max-width: 400px;">
                    <header style="color: var(--del-color);">âš ï¸ ç¡®è®¤åˆ é™¤</header>
                    <p style="font-size: 1rem; margin: 1.5rem 0;">
                        ç¡®å®šè¦åˆ é™¤è®¾å¤‡ <strong style="color: var(--del-color);">{{ deviceToDelete?.name }}</strong> å—ï¼Ÿ
                        <br><small class="text-muted" style="display: block; margin-top: 0.5rem;">æ­¤æ“ä½œæ— æ³•æ’¤é”€</small>
                    </p>
                    <footer>
                        <a href="#" role="button" class="secondary" @click.prevent="showDeleteModal = false">å–æ¶ˆ</a>
                        <button @click="deleteDevice" style="background-color: var(--del-color); border-color: var(--del-color);">ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤</button>
                    </footer>
                </article>
            </dialog>
        </div>
        
        <footer style="margin-top: 3rem; text-align: center; font-size: 0.8rem; color: #555;">
            WOLGoWeb <!--VERSION-->
        </footer>
    </div>

    <script>
        const { createApp, ref, onMounted, reactive, computed, nextTick, watch } = Vue;

        createApp({
            setup() {
                // Auth & State
                const token = ref(localStorage.getItem('wol_token') || '');
                const rememberUser = ref(localStorage.getItem('wol_remember_user') === 'true');
                const showPassword = ref(false);
                const loginForm = reactive({
                    username: localStorage.getItem('wol_username') || '',
                    password: ''
                });
                const loginError = ref('');

                // Data
                const devices = ref([]);
                const toasts = ref([]); // {id, message, type}
                
                // UI State
                const loading = ref(false);
                const refreshing = ref(false);
                const adding = ref(false);
                const showAddModal = ref(false);
                const showDeleteModal = ref(false);
                const showScanModal = ref(false);
                
                const scanning = ref(false);
                const scannedDevices = ref([]);
                const deviceToDelete = ref(null);
                const deviceNameInput = ref(null);

                // Filter & Sort
                const filterStatus = ref('all');
                const sortKey = ref('name'); // name, last_online
                const sortOrder = ref(1); // 1 asc, -1 desc
                
                // New Device Form
                const newDevice = reactive({ name: '', mac: '', ip: '', port: '9' });
                const macError = ref(false);

                // Computed
                const filteredDevices = computed(() => {
                    let res = devices.value;
                    // Filter
                    if (filterStatus.value === 'online') res = res.filter(d => d.is_online);
                    if (filterStatus.value === 'offline') res = res.filter(d => !d.is_online);
                    
                    // Sort
                    return res.slice().sort((a, b) => {
                        let valA = a[sortKey.value];
                        let valB = b[sortKey.value];
                        
                        // Handle uninitialized strings
                        if(valA === undefined) valA = '';
                        if(valB === undefined) valB = '';

                        if (sortKey.value === 'last_online') {
                            // Handle null/empty dates
                            const dateA = (!valA || valA.startsWith('0001')) ? 0 : new Date(valA).getTime();
                            const dateB = (!valB || valB.startsWith('0001')) ? 0 : new Date(valB).getTime();
                            return (dateA - dateB) * sortOrder.value;
                        }

                        if (valA < valB) return -1 * sortOrder.value;
                        if (valA > valB) return 1 * sortOrder.value;
                        return 0;
                    });
                });

                // Methods
                const showToast = (message, type = 'success') => {
                    const id = Date.now();
                    toasts.value.push({ id, message, type });
                    setTimeout(() => {
                        toasts.value = toasts.value.filter(t => t.id !== id);
                    }, 3000);
                };

                const api = async (endpoint, options = {}) => {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token.value}`
                    };
                    const res = await fetch(`/api${endpoint}`, { ...options, headers });
                    if (res.status === 401) {
                        logout();
                        throw new Error('Unauthorized');
                    }
                    if (!res.ok) {
                        const data = await res.json();
                        throw new Error(data.error || 'Request failed');
                    }
                    return res.json();
                };

                const login = async () => {
                    loading.value = true;
                    loginError.value = '';
                    try {
                        const res = await fetch('/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                        
                        token.value = data.token;
                        localStorage.setItem('wol_token', token.value);
                        
                        if (rememberUser.value) {
                            localStorage.setItem('wol_username', loginForm.username);
                            localStorage.setItem('wol_remember_user', 'true');
                        } else {
                            localStorage.removeItem('wol_username');
                            localStorage.setItem('wol_remember_user', 'false');
                        }
                        
                        fetchDevices();
                    } catch (e) {
                        loginError.value = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                    } finally {
                        loading.value = false;
                    }
                };

                const logout = () => {
                    token.value = '';
                    localStorage.removeItem('wol_token');
                };

                const fetchDevices = async (refresh = false) => {
                    refreshing.value = true;
                    try {
                        let url = '/devices';
                        if (refresh) url += '?refresh=true';
                        devices.value = await api(url);
                        devices.value.forEach(d => d.waking = false);
                        if(refresh) showToast('è®¾å¤‡çŠ¶æ€å·²æ›´æ–°');
                    } catch (e) {
                        console.error(e);
                        showToast('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥', 'error');
                    } finally {
                        refreshing.value = false;
                    }
                };

                // MAC Formatting Logic
                const formatMac = (e) => {
                    let val = e.target.value.toUpperCase().replace(/[^0-9A-F]/g, '');
                    let formatted = '';
                    for (let i = 0; i < val.length && i < 12; i++) {
                        if (i > 0 && i % 2 === 0) formatted += ':';
                        formatted += val[i];
                    }
                    newDevice.mac = formatted;
                    
                    // Regex Check
                    const re = /^([0-9A-F]{2}:){5}[0-9A-F]{2}$/;
                    macError.value = !re.test(formatted) && formatted.length > 0;
                };

                const openAddDeviceModal = (reset = true) => {
                    if (reset) {
                        Object.assign(newDevice, { name: '', mac: '', ip: '', port: '9' });
                        macError.value = false;
                    }
                    showAddModal.value = true;
                    nextTick(() => {
                        if (deviceNameInput.value) deviceNameInput.value.focus();
                    });
                };

                const addDevice = async () => {
                    if (macError.value) return;
                    adding.value = true;
                    try {
                        await api('/devices', {
                            method: 'POST',
                            body: JSON.stringify(newDevice)
                        });
                        showAddModal.value = false;
                        showToast('è®¾å¤‡æ·»åŠ æˆåŠŸ');
                        fetchDevices();
                    } catch (e) {
                        showToast('æ·»åŠ å¤±è´¥: ' + e.message, 'error');
                    } finally {
                        adding.value = false;
                    }
                };

                // Scanning
                const openScanModal = async () => {
                    showScanModal.value = true;
                    scanning.value = true;
                    scannedDevices.value = [];
                    try {
                        const res = await api('/scan');
                        const existingMacs = new Set(devices.value.map(d => d.mac));
                        scannedDevices.value = res.filter(d => !existingMacs.has(d.mac));
                    } catch (e) {
                        showToast('æ‰«æå¤±è´¥: ' + e.message, 'error');
                        showScanModal.value = false;
                    } finally {
                        scanning.value = false;
                    }
                };

                const addScannedDevice = (d) => {
                    newDevice.mac = d.mac;
                    newDevice.ip = d.ip;
                    newDevice.name = `Device-${d.ip.split('.').pop()}`;
                    showScanModal.value = false;
                    openAddDeviceModal(false); // Valid from scan usually
                    macError.value = false; 
                };

                // Deleting
                const confirmDelete = (device) => {
                    deviceToDelete.value = device;
                    showDeleteModal.value = true;
                };

                const deleteDevice = async () => {
                    if (!deviceToDelete.value) return;
                    try {
                        await api(`/devices/${deviceToDelete.value.id}`, { method: 'DELETE' });
                        showDeleteModal.value = false;
                        showToast('è®¾å¤‡å·²åˆ é™¤');
                        fetchDevices();
                    } catch (e) {
                        showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
                    }
                };

                // Waking
                const wakeDevice = async (device) => {
                    device.waking = true;
                    try {
                        await api(`/wake/${device.id}`, { method: 'POST' });
                        showToast(`å·²å‘ ${device.name} å‘é€å”¤é†’ä¿¡å·`);
                    } catch (e) {
                        showToast('å”¤é†’å¤±è´¥: ' + e.message, 'error');
                    } finally {
                        device.waking = false;
                    }
                };

                // Sorting
                const sortBy = (key) => {
                    if (sortKey.value === key) {
                        sortOrder.value *= -1;
                    } else {
                        sortKey.value = key;
                        sortOrder.value = 1;
                    }
                };
                
                const getSortClass = (key) => {
                    if (sortKey.value !== key) return 'sort-icon';
                    return sortOrder.value === 1 ? 'sort-asc' : 'sort-desc';
                };

                // Time Format
                const formatTime = (dateStr) => {
                    if (!dateStr || dateStr.startsWith('0001')) return 'ä»æœªåœ¨çº¿';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffHours = diffMs / (1000 * 60 * 60);

                    if (diffHours < 24 && now.getDate() === date.getDate()) {
                        return `ä»Šå¤© ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    } else if (diffHours < 24) {
                        return `${Math.floor(diffHours)} å°æ—¶å‰`;
                    } else {
                        return date.toLocaleString();
                    }
                };
                
                // Keyboard Support for Modals
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        showAddModal.value = false;
                        showScanModal.value = false;
                        showDeleteModal.value = false;
                    }
                };

                onMounted(() => {
                    if (token.value) {
                        fetchDevices();
                    }
                    window.addEventListener('keydown', handleKeydown);
                });

                return {
                    // Auth
                    token, loginForm, login, logout, loginError, showPassword, rememberUser,
                    // Data
                    filteredDevices, toasts,
                    // State
                    loading, refreshing, adding, showAddModal, showDeleteModal, showScanModal, scanning, scannedDevices,
                    deviceToDelete, newDevice, macError, deviceNameInput,
                    // Methods
                    fetchDevices,
                    openAddDeviceModal, addDevice, confirmDelete, deleteDevice, 
                    openScanModal, addScannedDevice, wakeDevice,
                    formatMac, formatTime, sortBy, getSortClass, 
                    filterStatus
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
