# Multi-stage build for WolGoWeb (Enhanced Version)
FROM --platform=${TARGETPLATFORM} golang:1.21-alpine AS builder

WORKDIR /build

# Copy source code
COPY ../src ./src
COPY ../go.mod ./go.mod
COPY ../go.sum ./go.sum

# Install dependencies and build
RUN go mod download && \
    go build -ldflags "-w -s" -trimpath -o WolGoWeb ./src

# Final stage
FROM --platform=${TARGETPLATFORM} alpine:latest

LABEL maintainer="WolGoWeb Enhanced"
LABEL description="Wake-on-LAN Web Management Tool with Modern UI"

ENV VERSION=${BUILD_VERSION:-latest}
ENV PORT=9090
ENV KEY=false
ENV WEB=true
ENV USERNAME=admin
ENV PASSWORD=admin
ENV TZ=Asia/Shanghai

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories && \
    apk add --no-cache tzdata && \
    ln -sf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    mkdir -p /web/data

WORKDIR /web

# Copy binary from builder
COPY --from=builder /build/WolGoWeb .

RUN chmod +x /web/WolGoWeb

VOLUME ["/web/data"]

EXPOSE $PORT

CMD ["/web/WolGoWeb", "-c", "env"]


